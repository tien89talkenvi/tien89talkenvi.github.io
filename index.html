<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiensg89's App</title>
<style>

    *, *::before, *::after {
        box-sizing: border-box;
    }

    body {
        display: grid;
        background-image: linear-gradient(-45deg, #f4d03f, #16a085);

        background-attachment: fixed;
        background-size: cover;
        justify-content: center;
        align-items: center;
        margin: 0;
        padding: 20px;
        color: #fff;
        font: 1rem/1 'Poppins', sans-serif;
    }
    .wrapper {
        display: grid;
        gap: 10px;
        width: 600px;
        max-width: calc(100vw - 40px);
        padding: 20px;
        border-radius: 10px;
        background-color: #0003}
    #wrapper-text {
        display: grid;
        gap: 10px;
        width: 600px;
        max-width: calc(100vw - 40px);
        padding: 20px;
        background-color: #0003}
    .properties {
        display: grid;
        grid-template-columns: max-content minmax(0, auto) 40px;
        gap: 20px;
        padding: 20px;
        background-color: #0003;
        font-size: 20px;
        border-radius: 10px;
        color: lightgreen;
        }
        .buttons1 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        justify-content: center;
        margin-top: 2px;
        padding-top: 2px;
        }
        .buttons2 {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        justify-content: center;
        margin-top: 2px;
        padding-top: 2px;
        }

        .buttons4 {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        justify-content: center;
        gap: 10px;
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #fff3;
        }
    button {
        padding: 5px;
        border: 1px solid #fff;
        border-radius: 999px;
        color: #fff;
        background-color: rgba(16, 16, 17, 0.253);
        font-size: inherit;
        font-family: inherit;
        cursor: pointer;
        appearance: none;
        }

    button:disabled {
        opacity: 0.25;
        cursor: not-allowed;
    }
    .center{text-align: center;
        color: yellow}
        #textid {
        display: block;
        line-height: 1.25;}
    textarea {
        font-family: Arial;
        font-size: 14pt;
        background-color: rgb(226, 247, 236);
        }

</style>    
</head>
<body>
<h1 class="center" translate="no">Speak Text</h1>  
<!--START textarea------------------------------------------------------------->  
<div class="wrapper">

<label for="message" translate="no" onclick="hdofTien89()">❓❓</label>

<textarea id="message"  spellcheck="false" name="message" rows="4" cols="60"> </textarea>

<!--Nhom nut dkhien 2----------------------------------------------------------->  
<div class="buttons1"> 
<button id="English" onclick="speak_text_all(this.id)" translate="no"><span style="color:lightblue">Speak En</span></button>
<button id="Vietnamese" onclick="speak_text_all(this.id)" translate="no"><span style="color:orange">Speak Vi</span></button>
</div>
<!--Nhom nut dkhien 3----------------------------------------------------------->  
<div class="buttons1">
<button id="stop1" onclick="stop1()" translate="no">Stop</button>
<button  onclick="clearbelow()" translate="no">Clear</button>
</div>
<!--Nhom nut dkhien 1----------------------------------------------------------->  

<div class="buttons2">
    <button  onclick="demtextxuong()" translate="no"><span style="color:lightgreen">Move text below to translate</span></button>
</div>

</div>
<hr>

<!--START code chon lang dich cua google-->  
<div id="google_translate_element" class="center" translate="no"><a translate="no">Translate text below to </a></div>
<span>
    <script type="text/javascript">
          //<![CDATA[
          function googleTranslateElementInit() {
              new google.translate.TranslateElement({
              pageLanguage: '', includedLanguages: 'en,vi', autoDisplay: false,
              layout: google.translate.TranslateElement.InlineLayout.SIMPLE
              }, 'google_translate_element');
          }
          //]]>
    </script>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</span>
<br>

<!-- div nay chua text de speak  ----------------------------------------------->

<div id="wrapper-text">

    <div id="t1" ></div>

</div>

<hr>
<!--Nhom nut dkhien 4 chi tiet them---------------------------------------------> 
<div class="wrapper">

    <div class="properties">
      <label for="voice" translate="no">Voice:</label>
      <select id="voice"></select>
      <div></div>
    </div>  

    <div class="properties">
        <label for="pitch" translate="no">Pitch:</label>
        <input id="pitch" type="range" min="0.1" max="2" step="0.1" value="1">
        <output for="pitch">1</output>
        
        <label for="rate" translate="no">Rate:</label>
        <input id="rate" type="range" min="0.1" max="2" step="0.1" value="1">
        <output for="rate">1</output>
        
        <label for="volume" translate="no">Volume:</label>
        <input id="volume" type="range" min="0" max="1" step="0.1" value="1">
        <output for="volume">1</output>
    </div>
    
    <div class="buttons4">
        <button id="play" onclick="play()" translate="no"><span style="color:yellow">Play</span></button>
        <button id="pause" disabled translate="no">Pause</button>
        <button id="stop" disabled translate="no">Stop</button>
        <button onclick="xoaduoi()" translate="no"><span style="color:lightblue">Clear</span></button>
    </div>
</div>

<!--============ Phan chua javascript dieu khien  ==========================----->



<script>
function speak_text_all(idname){
    if (idname.charAt(0) == 'V'){giongnoi='vi-VN';} else {giongnoi='en-US';}//dung V de neu co dich ra thi no van la V
    //cai lenh tren day khong lien quan voice phia duoi
    const textintextarea = document.getElementById("message").value;
    const utterance = new SpeechSynthesisUtterance(textintextarea);
    utterance.lang = giongnoi;
    window.speechSynthesis.speak(utterance);
}
    
function stop1() {
    window.speechSynthesis.cancel();
}
function clearbelow(){
    document.getElementById('message').value = "";
}
//----------------------------------
function demtextxuong(){
    let text_in_textarea = document.getElementById('message').value;
    document.getElementById('t1').textContent =  text_in_textarea;
    //document.getElementById('message').value = '';
}
//xu li voice --------------------------------------------------------------------------
const voiceInEl = document.getElementById('voice');//khai bao voiceInEl la bien toan cuc 

function updateVoices() {
    // lay cac voice dat vao cac option
    window.speechSynthesis.getVoices().forEach(voice => {
    const isAlreadyAdded = [...voiceInEl.options].some(option => option.value === voice.voiceURI);
    if (!isAlreadyAdded) {
        const option = new Option(voice.name, voice.voiceURI, voice.default, voice.default);
        voiceInEl.add(option);
    }
    });
}
//chay ham tren day updateVoices() de lay cac voice vao cac opption cua select
updateVoices(); //goi chay ham nay voi bien voiceInEl va dinh nghia ham o phia tren

//moi khi thay doi voice thi no cap nhat lai de co gtri moi 
window.speechSynthesis.onvoiceschanged = updateVoices;
//vi du de gan gtri voice hien hanh la voiceInEl.value cho dt utterance
//utterance.voice=window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
//xu li pit/rate/vol ----------------------------------------------------------------------------------
//khai bao cac bien toan cuc va gan gitri dau
const pitchInEl = document.getElementById('pitch');
const rateInEl = document.getElementById('rate');
const volumeInEl = document.getElementById('volume');

const pitchOutEl = document.querySelector('output[for="pitch"]');
const rateOutEl = document.querySelector('output[for="rate"]');
const volumeOutEl = document.querySelector('output[for="volume"]');

function updateOutputs() {//---------
    // display current values of all range inputs, phoi bay gtri hien huu
    pitchOutEl.textContent = pitchInEl.value;
    rateOutEl.textContent = rateInEl.value;
    volumeOutEl.textContent = volumeInEl.value;
}

// add UI event handlers, khi pit/rate/vol thay doi thi chay ham updateOutputs() o tren de lay gt moi
pitchInEl.addEventListener('change', updateOutputs);
rateInEl.addEventListener('change', updateOutputs);
volumeInEl.addEventListener('change', updateOutputs);

//Xu li 3 nut play/pause/stop2 phia duoi ======================================================


function play(){
    var textElement = document.getElementById('t1');
    var text = textElement.innerHTML;
    var vt1 = text.search(">");
    var vt2 = text.search("</");
    if (vt1>0 && vt2>0){
        text = text.substring(vt1+1, vt2);
        textElement.innerHTML = text;
        text = textElement.innerHTML;
    }    
    //alert(text);
    const playEl = document.getElementById('play');
    const pauseEl = document.getElementById('pause');
    const stopEl = document.getElementById('stop');

    // add UI event handlers
    playEl.addEventListener('click', play);
    pauseEl.addEventListener('click', pause);
    stopEl.addEventListener('click', stop);

    function playtrong(){
        if (window.speechSynthesis.speaking) {
            // there's an unfinished utterance
            window.speechSynthesis.resume();
        } else {
            //sua lai neu co
            var vt1 = text.search(">");
            var vt2 = text.search("</");
            if (vt1>0 && vt2>0){
                text = text.substring(vt1+1, vt2);
                textElement.innerHTML = text;
                text = textElement.innerHTML;
            }    

            // start new utterance
            const utterance = new SpeechSynthesisUtterance(text);

            utterance.addEventListener('start', handleStart);
            utterance.addEventListener('pause', handlePause);
            utterance.addEventListener('resume', handleResume);
            utterance.addEventListener('end', handleEnd);
            utterance.addEventListener('boundary', handleBoundary);

            utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
            utterance.pitch = pitchInEl.value;
            utterance.rate = rateInEl.value;
            utterance.volume = volumeInEl.value;

            window.speechSynthesis.speak(utterance);
    
        }
    }
    playtrong(text);

    function pause() {
        window.speechSynthesis.pause();
    }

    function stop() {
        window.speechSynthesis.cancel();
        // Safari doesn't fire the 'end' event when cancelling, so call handler manually
        handleEnd();
    }

    function handleStart() {
        playEl.disabled = true;
        pauseEl.disabled = false;
        stopEl.disabled = false;
    }

    function handlePause() {
        playEl.disabled = false;
        pauseEl.disabled = true;
        stopEl.disabled = false;
    }

    function handleResume() {
        playEl.disabled = true;
        pauseEl.disabled = false;
        stopEl.disabled = false;
    }

    function handleEnd() {
        playEl.disabled = false;
        pauseEl.disabled = true;
        stopEl.disabled = true;
        // reset text to remove mark
        textEl.innerHTML = text;
    }

    function handleBoundary(event) {
        if (event.name === 'sentence') {
            // we only care about word boundaries
            return;
        }

        const wordStart = event.charIndex;

        let wordLength = event.charLength;
        if (wordLength === undefined) {
            // Safari doesn't provide charLength, so fall back to a regex to find the current word and its length (probably misses some edge cases, but good enough for this demo)
            const match = text.substring(wordStart).match(/^[a-z\d']*/i);
            wordLength = match[0].length;
        }
  
        // wrap word in <mark> tag
        const wordEnd = wordStart + wordLength;
        const word = text.substring(wordStart, wordEnd);
        const markedText = text.substring(0, wordStart) + '<mark>' + word + '</mark>' + text.substring(wordEnd);
        textEl.innerHTML = markedText;
    }
}
//-------------------------------xoa text phan duoi------------------------
function xoaduoi(){
    document.getElementById('t1').innerHTML = "";
}
function hdofTien89(){
    var  vbhd="App này dùng để nghe văn bản Anh/Việt được đọc bởi trình duyệt và thiết bị. Sử dụng như sau:\n ";
    vbhd=vbhd+'- Bước 1: Nhập văn bản từ bàn phím hoặc copy từ thiết bị rồi paste vào trong khung hình chữ nhật.\n ';
    vbhd=vbhd+'- Bước 2: Nhấp nút "Speak En" hoặc "Speak Vi" để nghe văn bản vừa nhập bằng giọng đọc tiếng Anh hoặc Việt tùy văn bản trên.\n ';
    vbhd=vbhd+'- Bước 3: Nếu muốn dịch ra ngữ khác thì nhấp nút "Move text below to translate" ';
    vbhd=vbhd+'để đưa văn bản nhập ở phần trên xuống bên dưới rồi thao tác tiếp bằng các nút ở phần dưới. ';
    alert(vbhd);
}
</script>
    
</body>
</html>
