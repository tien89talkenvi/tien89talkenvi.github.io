<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
<style>
    *, *::before, *::after {
  box-sizing: border-box;
}

body {
  display: grid;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  margin: 0;
  padding: 20px;
  color: #fff;
  background-image: linear-gradient(45deg, #4158d0, #c850c0, #ffcc70);
  font: 1.25rem/1 'Poppins', sans-serif;
}

.wrapper {
  display: grid;
  gap: 20px;
  width: 600px;
  max-width: calc(100vw - 40px);
  padding: 30px;
  border-radius: 10px;
  background-color: #0003;
}
#text {
  display: block;
  line-height: 1.75;
}

.properties {
  display: grid;
  grid-template-columns: max-content minmax(0, auto) 40px;
  gap: 20px;
  padding: 20px;
  background-color: #0003;
}

#voice {
  font-size: 0.875rem;
  font-family: inherit;
}

#speak {
  padding: 10px;
  border: 1px solid #fff;
  color: #fff;
  background-color: #0009;
  font-size: inherit;
  font-family: inherit;
  cursor: pointer;
  appearance: none;
}
.buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  justify-content: center;
  gap: 10px;
  margin-top: 30px;
  padding-top: 30px;
  border-top: 1px solid #fff3;
}
button {
  padding: 5px;
  border: 1px solid #fff;
  border-radius: 999px;
  color: #fff;
  background-color: #0009;
  font-size: inherit;
  font-family: inherit;
  cursor: pointer;
  appearance: none;
}

button:disabled {
  opacity: 0.25;
  cursor: not-allowed;
}
mark {
  color: #000;
  background-color: #f4d03f;
}
textarea {
  width: 100%;
  height: 400px;
  padding: 12px 10px;
  box-sizing: border-box;
  border: 2px solid #ccc;
  border-radius: 4px;
  background-image: linear-gradient(45deg, #4158d0, #c850c0, #ffcc70);
  font-size: 16px;
  resize: none;
}
</style>
</head>
<body>
<h1>Put text into below</h1>
<textarea id="tienTextarea" spellcheck="false" >

</textarea>
<br>
<button type="button" onclick="moveTextDownAppend()">Move text down for listening</button>
<br>
<div class="wrapper">
        <div id="text"></div>
        <div class="properties">
          <label for="voice">Voice:</label>
          <select id="voice"></select>
          <div></div>
      
          <label for="pitch">Pitch:</label>
          <input id="pitch" type="range" min="0.1" max="2" step="0.1" value="1">
          <output for="pitch">1</output>
      
          <label for="rate">Rate:</label>
          <input id="rate" type="range" min="0.1" max="2" step="0.1" value="1">
          <output for="rate">1</output>
      
          <label for="volume">Volume:</label>
          <input id="volume" type="range" min="0" max="1" step="0.1" value="1">
          <output for="volume">1</output>
        </div>
  <div class="buttons">
    <button id="play">Speak</button>
    <button id="pause" disabled>Pause</button>
    <button id="stop" disabled>Stop</button>
  </div>
</div>

<script>
function moveTextDownAppend(){
    //chu y rang tag label co cong dung de API biet ma phan hoi khi bam nut xu li text trong do.
    let text_in_textarea = document.getElementById('tienTextarea').value;
    let text_in_text =  document.getElementById('text').innerHTML;
    document.getElementById('text').innerHTML =  text_in_text + text_in_textarea;
    //message.value += ' Appended text.';
    document.getElementById('tienTextarea').value = '';
}
</script>

<script>
// grab the UI elements to work with
//const textEl = document.getElementById('text');
const voiceInEl = document.getElementById('voice');
const pitchInEl = document.getElementById('pitch');
const rateInEl = document.getElementById('rate');
const volumeInEl = document.getElementById('volume');
const pitchOutEl = document.querySelector('output[for="pitch"]');
const rateOutEl = document.querySelector('output[for="rate"]');
const volumeOutEl = document.querySelector('output[for="volume"]');
//const speakEl = document.getElementById('speak');

// add UI event handlers
pitchInEl.addEventListener('change', updateOutputs);
rateInEl.addEventListener('change', updateOutputs);
volumeInEl.addEventListener('change', updateOutputs);
//speakEl.addEventListener('click', speakText);

// update voices immediately and whenever they are loaded
updateVoices();
window.speechSynthesis.onvoiceschanged = updateVoices;

function updateOutputs() {
  // display current values of all range inputs
  pitchOutEl.textContent = pitchInEl.value;
  rateOutEl.textContent = rateInEl.value;
  volumeOutEl.textContent = volumeInEl.value;
}

function updateVoices() {
  // add an option for each available voice that isn't already added
  window.speechSynthesis.getVoices().forEach(voice => {
    const isAlreadyAdded = [...voiceInEl.options].some(option => option.value === voice.voiceURI);
    if (!isAlreadyAdded) {
      const option = new Option(voice.name, voice.voiceURI, voice.default, voice.default);
      voiceInEl.add(option);
    }
  });
}
const textEl = document.getElementById('text'); //de dua text vao element nay cho viec doc dich (**)
//const textEl = document.getElementById('tienTextarea');
const playEl = document.getElementById('play');
const pauseEl = document.getElementById('pause');
const stopEl = document.getElementById('stop');

// add UI event handlers
playEl.addEventListener('click', play);
pauseEl.addEventListener('click', pause);
stopEl.addEventListener('click', stop);

var text=""; //khoi dong text co gtri ''
function moveTextDownAppend() {
    //Buoc 1: lay text hien co trong element id 'text' luu vao bien idtextluu
    let idtextluu = document.getElementById('text').innerHTML;
    //Buoc 2: lay noi dung trong tienTextarea
    let textlay = document.getElementById('tienTextarea').value;
    //Buoc 3: gan tong 2 text cho getElementById('text').textContent, no xoa va de
    text =  idtextluu + ' ' + textlay;
    document.getElementById('text').innerHTML = text;
    //Buoc 4: xoa text trong tienTextarea
    document.getElementById('tienTextarea').value="";
    //alert(text);
}

// set text
textEl.innerHTML = text; //(**)

function play() {
  if (window.speechSynthesis.speaking) {
    // there's an unfinished utterance
    window.speechSynthesis.resume();
  } else {
    // start new utterance

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.addEventListener('start', handleStart);
    utterance.addEventListener('pause', handlePause);
    utterance.addEventListener('resume', handleResume);
    utterance.addEventListener('end', handleEnd);
    utterance.addEventListener('boundary', handleBoundary);
utterance.voice = window.speechSynthesis.getVoices().find(voice => voice.voiceURI === voiceInEl.value);
utterance.pitch = pitchInEl.value;
utterance.rate = rateInEl.value;
utterance.volume = volumeInEl.value;

    window.speechSynthesis.speak(utterance);
  }
}

function pause() {
  window.speechSynthesis.pause();
}

function stop() {
  window.speechSynthesis.cancel();
  
  // Safari doesn't fire the 'end' event when cancelling, so call handler manually
  handleEnd();
}

function handleStart() {
  playEl.disabled = true;
  pauseEl.disabled = false;
  stopEl.disabled = false;
}

function handlePause() {
  playEl.disabled = false;
  pauseEl.disabled = true;
  stopEl.disabled = false;
}

function handleResume() {
  playEl.disabled = true;
  pauseEl.disabled = false;
  stopEl.disabled = false;
}

function handleEnd() {
  playEl.disabled = false;
  pauseEl.disabled = true;
  stopEl.disabled = true;
  
  // reset text to remove mark
  textEl.innerHTML = text;
}

function handleBoundary(event) {
  if (event.name === 'sentence') {
    // we only care about word boundaries
    return;
  }

  const wordStart = event.charIndex;

  let wordLength = event.charLength;
  if (wordLength === undefined) {
    // Safari doesn't provide charLength, so fall back to a regex to find the current word and its length (probably misses some edge cases, but good enough for this demo)
    const match = text.substring(wordStart).match(/^[a-z\d']*/i);
    wordLength = match[0].length;
  }
  
  // wrap word in <mark> tag
  const wordEnd = wordStart + wordLength;
  const word = text.substring(wordStart, wordEnd);
  const markedText = text.substring(0, wordStart) + '<mark>' + word + '</mark>' + text.substring(wordEnd);
  textEl.innerHTML = markedText;
}
//////////////

</script>
</body>
</html>
